# 磁盘文件系统压力测试

## 一、项目介绍

### 1. 目标

本项目聚焦于**磁盘文件系统的稳定性验证**，实现了一套支持 “手动功能验证” 与 “自动化压力测试” 的完整工具链。核心目标是：

- 验证磁盘文件系统核心功能（创建、读写、复制、删除等）的正确性；
- 测试文件系统在**长时间、高并发**场景下的稳定性与资源占用合理性；
- 封装文件系统核心逻辑为共享库（`libdiskfs.so`），实现模块复用与解耦。

### 2. 核心特性

- 支持手动交互测试：逐条执行文件操作命令，验证基础功能；
- 支持自动化压力测试：12 小时持续高并发操作，实时监控 CPU / 内存占用；
- 生成标准共享库：核心逻辑封装为`libdiskfs.so`，供主程序与测试程序调用；
- 完整日志记录：压力测试过程中自动记录操作数、成功率、资源数据，便于结果分析；
- 跨模块协同：线程池并发调度、资源监控、日志统计模块联动，模拟真实高负载场景。

## 二、环境要求

- 操作系统：Linux（Ubuntu 18.04+/CentOS 7+ 推荐）
- 编译器：GCC 9.0+（支持 C++11 标准）
- 依赖库：Pthread 线程库（Linux 系统默认自带）
- 构建工具：GNU Make（默认系统自带）

## 三、编译说明

项目通过 Makefile 实现自动化构建，支持 “主程序 + 共享库” 默认编译、“测试程序” 单独编译，步骤如下：

### 1. 编译前准备

进入项目根目录（目录名为 `disk_simulator_v2/`）：

```bash
cd disk_simulator
```

### 2. 核心编译命令

| 命令         | 功能描述                                                     |
| ------------ | ------------------------------------------------------------ |
| `make`       | 默认编译：生成主程序（`sim_disk`）和共享库（`libdiskfs.so`），不编译测试程序 |
| `make test`  | 单独编译测试程序：生成自动化压力测试程序（`test_disk`），依赖共享库（自动补全） |
| `make clean` | 清理产物：删除所有目标文件（`.o`）、可执行文件、共享库及虚拟磁盘镜像 |

### 3. 编译产物说明

编译后项目根目录将生成以下核心文件：

- `sim_disk`：主程序（文件系统模拟器，支持手动交互测试）；
- `libdiskfs.so`：共享库（封装磁盘初始化、文件操作、位图管理等核心逻辑）；
- `test_disk`：测试程序（自动化压力测试工具，仅`make test`后生成）；
- `stress_test.log`：压力测试日志（测试执行后自动生成，记录核心数据）。

## 四、使用方法

### 1. 手动交互测试（验证基础功能）

通过主程序`sim_disk`进行逐条命令测试，验证文件系统核心功能：

#### 步骤 1：启动模拟器

```bash
# 启动模拟器
./sim_disk
```

#### 步骤 2：执行核心命令

| 命令格式                       | 功能描述                                         | 示例（输入→输出）                                           |                |
| ------------------------------ | ------------------------------------------------ | ----------------------------------------------------------- | -------------- |
| `touch <文件名>`               | 创建空文件（自动分配 inode，创建成功直接提示）   | 输入：`touch note.txt` → 输出：`创建成功`                   |                |
| `write <文件名> "<内容>"`      | 向文件写入字符串（覆盖原有内容，支持≤1024 字节） | 输入：`write note.txt "v2 作业测试内容"` → 输出：`写入成功` |                |
| `cat <文件名>`                 | 读取文件全部内容（直接通过文件名访问）           | 输入：`cat note.txt` → 输出：`v2 作业测试内容`              |                |
| `copy <源文件名> <目标文件名>` | 复制文件（源文件需存在，目标文件自动创建）       | 输入：`copy note.txt note_copy.txt` → 输出：`复制成功`      |                |
| `ls`                           | 列出当前目录所有有效文件（展示核心信息）         | 输入：`ls` → 输出：`note.txt                                | note_copy.txt` |
| `rm <文件名>`                  | 删除文件（彻底移除，删除成功提示）               | 输入：`rm note_copy.txt` → 输出：`删除成功`                 |                |
| `exit`                         | 退出文件系统模拟器                               | 输入：`exit` → 输出：`程序退出`                             |                |

#### 步骤 3：退出模拟器

执行 `exit` 命令即可退出，所有元数据已通过`umount`同步到虚拟磁盘文件。

### 2. 自动化压力测试（验证高并发稳定性）

通过测试程序`test_disk`执行 12 小时高并发压力测试，自动记录结果：

#### 步骤 1：编译测试程序（若未编译）

```bash
make test
```

#### 步骤 2：启动压力测试

```bash
# 启动12小时压力测试（默认参数：每秒10次操作，预创建50个初始文件）
./test_disk
```

#### 步骤 3：查看测试状态与结果

- **实时状态**：终端每 10 min 输出一次累计操作数、CPU 使用率、内存占用；
- **日志记录**：测试过程中自动生成`stress_test.log`，记录每条操作的时间戳、结果、资源数据；
- **最终结果**：12 小时测试结束后，终端输出总操作数、成功率、峰值资源占用，日志文件自动归档。

#### 核心测试参数（可在代码中调整）

- 测试时长：`TEST_DURATION_HOURS = 12`（12 小时）；
- 每秒操作数：`MAX_OPS_PER_SECOND = 10`（10 次 / 秒）；
- 初始文件数：`INIT_FILE_COUNT = 50`（预创建 50 个测试文件）；
- 操作类型：随机覆盖`LS/CAT/WRITE/RM+TOUCH/COPY`五类命令。

### 3. 共享库使用说明

`libdiskfs.so` 封装了文件系统核心逻辑，可被其他程序复用：

- 链接方式：编译时通过 `-L. -ldiskfs` 指定库路径与库名；

- 核心接口：包含磁盘格式化（`disk_format`）、文件操作（touch/write/read`）、资源监控等接口，具体可参考`include/`目录下的头文件；

- 运行依赖：若执行程序时提示 “找不到 libdiskfs.so”，需临时指定库路径：

  ```bash
  export LD_LIBRARY_PATH=./:$LD_LIBRARY_PATH
  ```

## 五、项目目录结构

```plaintext
disk_simulator_v2/
├── include/                    # 头文件目录（模块接口声明）
│   ├── command_parser.h        # 命令解析模块接口（声明ls/cat/rm等命令处理逻辑）
│   ├── disk_fs.h               # 文件系统核心接口（声明磁盘操作、文件管理等核心功能）
│   └── task_queue.h            # 任务队列接口（声明并发任务的缓存与调度方法）
├── src/                        # 源文件目录（核心逻辑实现）
│   ├── bitmap_ops.cpp          # 位图操作实现（inode位图、数据块位图的分配与回收）
│   ├── block_ops.cpp           # 数据块操作实现（磁盘数据块的读写、映射管理）
│   ├── command_parser.cpp      # 命令解析逻辑实现（解析用户输入的ls/cat等命令并执行）
│   ├── disk_init.cpp           # 磁盘初始化实现（虚拟磁盘的格式化、挂载/卸载流程）
│   ├── file_ops.cpp            # 文件操作实现（touch/write/cat/copy/rm/ls等核心命令逻辑）
│   ├── main.cpp                # 主程序入口（手动交互测试的启动与循环逻辑）
│   ├── pos_calc.cpp            # 地址计算实现（inode、数据块在磁盘中的位置映射计算）
│   └── task_queue.cpp          # 任务队列实现（压力测试中并发任务的缓存与分发）
├── test/                       # 测试程序目录
│   └── stress_test.cpp         # 压力测试入口（自动化高并发测试的主逻辑）
├── Makefile                    # 项目构建脚本（编译主程序、共享库、测试程序的规则）
├── README.md                   # 项目说明文档（包含编译、使用、目录结构等说明）
├── stress_disk.img             # 压力测试专用虚拟磁盘文件（测试过程中自动创建/更新）
└── stress_test.log             # 压力测试日志文件（记录操作数、成功率、资源占用等数据）
```

## 六、核心功能说明

### 1. 手动交互测试功能

- 文件操作：创建、读写、复制、删除、目录列表；
- 异常处理：参数错误、未挂载操作、无效 inode 等场景的友好提示。

### 2. 自动化压力测试功能

- 高并发调度：基于线程池实现每秒 10 次并发操作，支持任务队列缓存；
- 随机任务生成：均匀覆盖五类核心操作，模拟真实使用场景；
- 实时资源监控：CPU 使用率、内存占用实时采集与记录；
- 结果追溯：日志文件完整记录每一次操作的结果与上下文，支持后续分析。

### 3. 共享库核心能力

- 模块化封装：将磁盘管理、文件操作、资源监控等逻辑拆分封装，降低耦合；
- 跨程序复用：主程序与测试程序共用同一套核心逻辑，避免重复开发；
- 可扩展性：支持后续扩展多级目录、权限管理等功能，接口兼容。

## 七、注意事项

1. 运行环境限制：仅支持 Linux 系统，Windows/macOS 需通过虚拟机或 WSL2 运行；
2. 共享库路径：执行`sim_disk`或`test_disk`前，需确保`libdiskfs.so`在当前目录，或通过`LD_LIBRARY_PATH`指定路径；
3. 虚拟磁盘文件：disk.img`为测试用虚拟磁盘，删除后需重新执行`format`初始化；
4. 测试时长调整：若需缩短测试时间，可修改`test/stress_test.cpp`中的`TEST_DURATION_HOURS`宏定义（如改为 1 小时）；
5. 日志文件：`stress_test.log`会以追加模式写入，多次测试需手动删除旧日志或备份。

## 八、项目要点

1. 编译验证：`make`可生成`sim_disk`与`libdiskfs.so`，`make test`可生成`test_disk`，无编译错误；
2. 手动测试：执行`ls/cat/rm/copy/write/touch/exit`等命令，功能正常无崩溃；
3. 压力测试：启动`test_disk`，程序稳定运行，日志与终端输出正常；
4. 结果分析：12 小时测试结束后，总操作数约 39 万～43 万次，成功率 100%，资源占用稳定（CPU≈0.56%，内存≈3MB）。